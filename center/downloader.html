<!DOCTYPE html>
<html lang="ko">

<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130136264-12"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	
	  gtag('config', 'UA-130136264-12');
	</script>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="css/style.css" rel="stylesheet">	
	<title>DUNI PILOT Center</title>	
</head>
<body>

<body id="page-top">
	<div id="wrapper">
		<div id="content-wrapper" class="d-flex flex-column">     
     	<div id="content">
     		<div class="container-fluid">          
          <div class="row">
						 <div class="col-xl-12 col-md-12 mb-4">
				     		<div class="card shadow py-2">
	                <div class="card-body text-center">
	                	<img src="../images/duni_logo.png" width="50" border="0"><br>
	                	<a href="/index.html" class="d-sm-inline-block btn btn-sm btn-info shadow-sm">DUNI PILOT Center</a>
	                </div>
	              </div>
	              
	              <div class="card shadow py-2" id="screenDownloadComplete">
	              	<div class="card-body text-center">
	              		다운로드가 완료되었습니다. 다운로드가 완료된 파일은 최소 1일 이내에 서버에서 삭제되고 다시 다운로드 할 수 없습니다.<br>
	              		(Download is complete. Files that have been downloaded will be deleted from the server within at least 1 day and cannot be re-downloaded.)
	              	</div>
	              </div>
	              
	              <div class="card shadow py-2" id="screenDownloadProgress">
	                <div class="card-body text-center">
	                	<div class="col">	                		
	                		<img src="../images/loader.gif" border=0> <img src="../images/loader.gif" border=0>
	                	</div>
	                	<div class="col">
	                		<img src="./imgs/duni_logo.png" border=0>
	                	</div>
	                	<div class="col">
	                		<img src="../images/loader.gif" border=0> <img src="../images/loader.gif" border=0>
	                	</div>
	                </div>
	                
	                <div class="card-body text-center">
										<progress id="progressBarForDownload" value="0" max="100" style="width:100%;height:5px"></progress>
									</div>
								</div>
								
								<div class="card shadow py-2" id="screenDownloadProgress">
	                <div class="card-body text-center">
	                	<div class="row">
											<div class="col-md-6 text-left">
												<p><small>&copy; <script>var cYear=(new Date()).getFullYear();document.write(cYear);</script> <a href="https://aply.biz" target="_new">APLY Inc.</a></small></p>
											</div>
											<div class="col-md-6 text-right">
												<a href="/privacy.html" target=_new>Privacy</a> &nbsp; <a href="/service.html" target=_new>Terms of Use</a>
											</div>
										</div>
	                </div>
	              </div>
																
     				 </div>
    			</div>
    		</div>
    	</div>
    </div>
	</div>

<script src="./vendor/jquery/jquery.min.js"></script>
<script>

function loadEnd(e) {
  $("#screenDownloadComplete").show();
  $("#screenDownloadProgress").hide();
}

function downloadFile(file_url) {	
	let temp_file_name = file_url.substring(file_url.lastIndexOf("/") + 1).split("?")[0];
	var xhrObj = new XMLHttpRequest();
	xhrObj.addEventListener("loadend", loadEnd);
	xhrObj.responseType = 'blob';
	xhrObj.onload = function () {
	    var linker = document.createElement('a');
	    linker.href = window.URL.createObjectURL(xhrObj.response);
	    linker.download = temp_file_name;
	    linker.style.display = 'none';    
	    document.body.appendChild(linker);
	    linker.click();
	    delete linker;
	};
	xhrObj.onprogress = function (e) {
			let pos = Math.floor(e.loaded / e.total * 100);
			$("#progressBarForDownload").val(pos);
	};
	xhrObj.open('GET', file_url);
	xhrObj.send();
}

function getQueryVariable() {
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == "id") {
            return "https://s3.ap-northeast-2.amazonaws.com/io.droneplay/temp_user_files/" + decodeURIComponent(pair[1]);
        }
    }
    
    return "";
}

$(function () {

	let file_url = getQueryVariable();
	
	$("#screenDownloadComplete").hide();
	
	if (file_url == "") {
		alert("Invalid access");
		location.href="/index.html";
	}
	else {
		downloadFile(file_url);	
	}

});

</script>


</body>
</html>